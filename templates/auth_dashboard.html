<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Podcast Analysis v2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-100" x-data="authApp()" x-init="init()">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-podcast text-2xl text-indigo-600"></i>
                        <span class="ml-2 text-xl font-bold text-gray-900">Podcast Analysis v2</span>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button @click="currentPage = 'dashboard'" 
                            :class="currentPage === 'dashboard' ? 'text-indigo-600' : 'text-gray-500 hover:text-gray-700'"
                            class="px-3 py-2 rounded-md text-sm font-medium">Dashboard</button>
                    <button @click="currentPage = 'knowledge'" 
                            :class="currentPage === 'knowledge' ? 'text-indigo-600' : 'text-gray-500 hover:text-gray-700'"
                            class="px-3 py-2 rounded-md text-sm font-medium">Knowledge Base</button>
                    <button @click="currentPage = 'podcasts'" 
                            :class="currentPage === 'podcasts' ? 'text-indigo-600' : 'text-gray-500 hover:text-gray-700'"
                            class="px-3 py-2 rounded-md text-sm font-medium">Podcasts</button>
                    
                    <!-- User Menu -->
                    <div class="flex items-center space-x-2 border-l pl-4">
                        <span class="text-sm text-gray-600" x-text="userEmail"></span>
                        <button @click="logout()" 
                                class="bg-red-600 text-white px-3 py-1 rounded-md text-sm hover:bg-red-700">
                            <i class="fas fa-sign-out-alt mr-1"></i>
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- Dashboard Page -->
        <div x-show="currentPage === 'dashboard'" class="space-y-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">
                    <i class="fas fa-tachometer-alt mr-3 text-indigo-600"></i>
                    Your Learning Dashboard
                </h1>
                <p class="mt-2 text-gray-600">Welcome back! Here's your personalized podcast learning overview.</p>
            </div>

            <!-- Stats Overview -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <i class="fas fa-file-alt text-2xl text-indigo-600"></i>
                            </div>
                            <div class="ml-5">
                                <dt class="text-sm font-medium text-gray-500 truncate">Total Analyses</dt>
                                <dd class="text-2xl font-bold text-gray-900" x-text="stats.totalAnalyses || 'Loading...'"></dd>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <i class="fas fa-clock text-2xl text-green-600"></i>
                            </div>
                            <div class="ml-5">
                                <dt class="text-sm font-medium text-gray-500 truncate">Reading Time (Week)</dt>
                                <dd class="text-2xl font-bold text-gray-900" x-text="stats.weeklyReadingTime || 'Loading...'"></dd>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <i class="fas fa-brain text-2xl text-purple-600"></i>
                            </div>
                            <div class="ml-5">
                                <dt class="text-sm font-medium text-gray-500 truncate">Knowledge Entries</dt>
                                <dd class="text-2xl font-bold text-gray-900" x-text="stats.knowledgeEntries || 'Loading...'"></dd>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <i class="fas fa-rss text-2xl text-orange-600"></i>
                            </div>
                            <div class="ml-5">
                                <dt class="text-sm font-medium text-gray-500 truncate">Active Subscriptions</dt>
                                <dd class="text-2xl font-bold text-gray-900" x-text="stats.activeSubscriptions || 'Loading...'"></dd>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Recent Analyses -->
                <div class="bg-white shadow rounded-lg">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900">Recent Analyses</h3>
                    </div>
                    <div class="px-6 py-4">
                        <div class="space-y-4">
                            <template x-for="analysis in recentAnalyses" :key="analysis.id">
                                <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 cursor-pointer">
                                    <h4 class="text-sm font-medium text-gray-900" x-text="analysis.title"></h4>
                                    <p class="text-sm text-gray-500 mt-1" x-text="analysis.podcast"></p>
                                    <div class="mt-2 flex items-center space-x-2">
                                        <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs">
                                            <span x-text="analysis.readingTime"></span>
                                        </span>
                                        <span x-show="analysis.hasKeyQuote" class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs">
                                            Key Quote
                                        </span>
                                    </div>
                                </div>
                            </template>
                            <div x-show="recentAnalyses.length === 0" class="text-center py-4 text-gray-500">
                                No recent analyses found
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="bg-white shadow rounded-lg">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900">Quick Actions</h3>
                    </div>
                    <div class="px-6 py-4">
                        <div class="grid grid-cols-1 gap-4">
                            <button @click="currentPage = 'podcasts'" class="inline-flex items-center px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                                <i class="fas fa-plus mr-2"></i>
                                Add Podcast
                            </button>
                            <button @click="currentPage = 'knowledge'" class="inline-flex items-center px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">
                                <i class="fas fa-search mr-2"></i>
                                Search Knowledge
                            </button>
                            <button @click="sendTestEmail()" class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                                <i class="fas fa-envelope mr-2"></i>
                                Send Test Email
                            </button>
                            <button @click="sendWeeklyDigest()" class="inline-flex items-center px-4 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700">
                                <i class="fas fa-paper-plane mr-2"></i>
                                Send Digest
                            </button>
                            <button @click="showEmailSettings = true" class="inline-flex items-center px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">
                                <i class="fas fa-cog mr-2"></i>
                                Email Settings
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Knowledge Base Page -->
        <div x-show="currentPage === 'knowledge'" class="space-y-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">
                    <i class="fas fa-brain mr-3 text-purple-600"></i>
                    Your Knowledge Base
                </h1>
                <p class="mt-2 text-gray-600">Organize, search, and explore your podcast learning insights.</p>
            </div>

            <div class="bg-white shadow rounded-lg">
                <div class="px-6 py-4">
                    <div class="space-y-4">
                        <template x-for="entry in knowledgeEntries" :key="entry.id">
                            <div class="border border-gray-200 rounded-lg p-4" x-data="{ expanded: false }">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <h3 class="text-lg font-medium text-gray-900" x-text="entry.entry_title"></h3>
                                        <p class="text-sm text-gray-500 mt-1">
                                            <span x-text="entry.podcast_name"></span> • 
                                            <span x-text="entry.reading_time_minutes + ' min read'"></span>
                                        </p>
                                        <p class="text-sm text-gray-600 mt-2" x-show="!expanded" x-text="entry.key_insights.substring(0, 200) + '...'"></p>
                                    </div>
                                    <button @click="expanded = !expanded" class="ml-4 text-indigo-600 hover:text-indigo-800">
                                        <i x-show="!expanded" class="fas fa-chevron-down"></i>
                                        <i x-show="expanded" class="fas fa-chevron-up"></i>
                                    </button>
                                </div>
                                
                                <!-- Expanded Content -->
                                <div x-show="expanded" x-transition class="mt-4 border-t pt-4">
                                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                        <!-- Full Analysis -->
                                        <div>
                                            <h4 class="font-semibold text-gray-900 mb-2">Full Insights</h4>
                                            <p class="text-sm text-gray-700 whitespace-pre-wrap" x-text="entry.key_insights"></p>
                                        </div>
                                        
                                        <!-- Actions -->
                                        <div>
                                            <h4 class="font-semibold text-gray-900 mb-2">Actions</h4>
                                            <div class="space-y-2">
                                                <button @click="viewFullAnalysis(entry.id)" class="w-full text-left px-3 py-2 bg-blue-50 text-blue-700 rounded-md hover:bg-blue-100">
                                                    <i class="fas fa-file-alt mr-2"></i>
                                                    View Full Analysis Report
                                                </button>
                                                <button @click="viewTranscript(entry.episode_id)" class="w-full text-left px-3 py-2 bg-green-50 text-green-700 rounded-md hover:bg-green-100">
                                                    <i class="fas fa-file-text mr-2"></i>
                                                    View Episode Transcript
                                                </button>
                                                <button @click="toggleFavorite(entry.id)" class="w-full text-left px-3 py-2 bg-yellow-50 text-yellow-700 rounded-md hover:bg-yellow-100">
                                                    <i :class="entry.is_favorited ? 'fas fa-star' : 'far fa-star'" class="mr-2"></i>
                                                    <span x-text="entry.is_favorited ? 'Remove from Favorites' : 'Add to Favorites'"></span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Tags and Metadata -->
                                    <div class="mt-4 pt-4 border-t">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center space-x-2">
                                                <span x-show="entry.is_favorited" class="text-yellow-400">
                                                    <i class="fas fa-star"></i>
                                                </span>
                                                <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded" x-text="entry.tags"></span>
                                                <span class="text-xs text-gray-400" x-text="entry.created_at"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                        <div x-show="knowledgeEntries.length === 0" class="text-center py-8 text-gray-500">
                            No knowledge entries found
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Podcasts Page -->
        <div x-show="currentPage === 'podcasts'" class="space-y-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">
                        <i class="fas fa-podcast mr-3 text-indigo-600"></i>
                        Your Podcasts
                    </h1>
                    <p class="mt-2 text-gray-600">Manage your podcast subscriptions and discover new content.</p>
                </div>
                <button @click="showAddPodcast = true" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">
                    <i class="fas fa-plus mr-2"></i>
                    Add New Podcast
                </button>
            </div>

            <!-- Add Podcast Modal -->
            <div x-show="showAddPodcast" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-medium text-gray-900">Add New Podcast</h3>
                        <button @click="showAddPodcast = false" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <form @submit.prevent="addNewPodcast()" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Podcast Name</label>
                            <input x-model="newPodcast.name" type="text" required 
                                   class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">RSS Feed URL</label>
                            <input x-model="newPodcast.rss_url" type="url" required 
                                   class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2"
                                   placeholder="https://example.com/feed.xml">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Author (optional)</label>
                            <input x-model="newPodcast.author" type="text" 
                                   class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Description (optional)</label>
                            <textarea x-model="newPodcast.description" rows="3"
                                      class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2"></textarea>
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button type="button" @click="showAddPodcast = false" 
                                    class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400">
                                Cancel
                            </button>
                            <button type="submit" :disabled="loading"
                                    class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 disabled:opacity-50">
                                <span x-show="!loading">Add Podcast</span>
                                <span x-show="loading">Adding...</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Email Settings Modal -->
            <div x-show="showEmailSettings" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-medium text-gray-900">Email Settings</h3>
                        <button @click="showEmailSettings = false" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <form @submit.prevent="updateEmailSettings()" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Email Frequency</label>
                            <select x-model="emailSettings.frequency" 
                                    class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2">
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="biweekly">Bi-weekly</option>
                                <option value="monthly">Monthly</option>
                                <option value="never">Never</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Preferred Time</label>
                            <input x-model="emailSettings.preferred_time" type="time" 
                                   class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2">
                        </div>
                        <div>
                            <label class="flex items-center">
                                <input x-model="emailSettings.include_summaries" type="checkbox" 
                                       class="rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                <span class="ml-2 text-sm text-gray-700">Include episode summaries</span>
                            </label>
                        </div>
                        <div>
                            <label class="flex items-center">
                                <input x-model="emailSettings.include_quotes" type="checkbox" 
                                       class="rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                <span class="ml-2 text-sm text-gray-700">Include key quotes</span>
                            </label>
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button type="button" @click="showEmailSettings = false" 
                                    class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400">
                                Cancel
                            </button>
                            <button type="submit" :disabled="loading"
                                    class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 disabled:opacity-50">
                                <span x-show="!loading">Save Settings</span>
                                <span x-show="loading">Saving...</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Podcast Discovery Section -->
            <div class="bg-white shadow rounded-lg">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">Popular Podcasts to Discover</h3>
                </div>
                <div class="px-6 py-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <template x-for="suggestion in podcastSuggestions" :key="suggestion.name">
                            <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50">
                                <h4 class="font-medium text-gray-900" x-text="suggestion.name"></h4>
                                <p class="text-sm text-gray-500 mt-1" x-text="suggestion.author"></p>
                                <p class="text-sm text-gray-600 mt-2" x-text="suggestion.description"></p>
                                <button @click="quickAddPodcast(suggestion)" 
                                        class="mt-3 w-full bg-indigo-50 text-indigo-700 px-3 py-2 rounded-md hover:bg-indigo-100">
                                    <i class="fas fa-plus mr-2"></i>
                                    Quick Add
                                </button>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Your Subscriptions -->
            <div class="bg-white shadow rounded-lg">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">Your Subscriptions</h3>
                </div>
                <div class="px-6 py-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <template x-for="podcast in podcasts" :key="podcast.id">
                            <div class="border border-gray-200 rounded-lg p-4" x-data="{ showSettings: false }">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <h3 class="text-lg font-medium text-gray-900" x-text="podcast.name"></h3>
                                        <p class="text-sm text-gray-500 mt-1" x-text="podcast.author"></p>
                                        <p class="text-sm text-gray-600 mt-2" x-text="podcast.episode_count + ' episodes • ' + podcast.analysis_count + ' analyses'"></p>
                                    </div>
                                    <button @click="showSettings = !showSettings" class="text-gray-400 hover:text-gray-600">
                                        <i class="fas fa-cog"></i>
                                    </button>
                                </div>
                                
                                <div class="mt-3 flex items-center justify-between">
                                    <span x-show="podcast.subscribed" class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">
                                        ✅ Subscribed
                                    </span>
                                    <span x-show="!podcast.subscribed" class="bg-gray-100 text-gray-800 px-2 py-1 rounded text-xs">
                                        Not subscribed
                                    </span>
                                </div>

                                <!-- Settings Panel -->
                                <div x-show="showSettings" x-transition class="mt-4 pt-4 border-t">
                                    <div class="space-y-2">
                                        <button @click="editPrompt(podcast.id)" class="w-full text-left px-3 py-2 bg-blue-50 text-blue-700 rounded-md hover:bg-blue-100">
                                            <i class="fas fa-edit mr-2"></i>
                                            Edit Analysis Prompt
                                        </button>
                                        <button @click="processRSS(podcast.id)" class="w-full text-left px-3 py-2 bg-green-50 text-green-700 rounded-md hover:bg-green-100">
                                            <i class="fas fa-sync mr-2"></i>
                                            Check for New Episodes
                                        </button>
                                        <button @click="deletePodcast(podcast.id, podcast.name)" class="w-full text-left px-3 py-2 bg-red-50 text-red-700 rounded-md hover:bg-red-100">
                                            <i class="fas fa-trash mr-2"></i>
                                            Delete Podcast
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading indicator -->
    <div x-show="loading" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <div class="flex items-center">
                <i class="fas fa-spinner fa-spin text-indigo-600 mr-3"></i>
                <span>Loading...</span>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div x-show="notification.show" x-transition class="fixed bottom-4 right-4 bg-white shadow-lg rounded-lg p-4 max-w-sm">
        <div class="flex items-center">
            <div class="flex-shrink-0">
                <i :class="notification.type === 'success' ? 'fas fa-check-circle text-green-400' : 'fas fa-exclamation-circle text-red-400'"></i>
            </div>
            <div class="ml-3">
                <p class="text-sm font-medium text-gray-900" x-text="notification.message"></p>
            </div>
        </div>
    </div>

    <script>
        function authApp() {
            return {
                currentPage: 'dashboard',
                loading: false,
                userEmail: '',
                token: '',
                
                // Data
                stats: {},
                recentAnalyses: [],
                knowledgeEntries: [],
                podcasts: [],
                
                // UI State
                showAddPodcast: false,
                showEmailSettings: false,
                newPodcast: {
                    name: '',
                    rss_url: '',
                    author: '',
                    description: ''
                },
                
                // Email Settings
                emailSettings: {
                    frequency: 'weekly',
                    preferred_time: '09:00',
                    include_summaries: true,
                    include_quotes: true
                },
                
                // Podcast suggestions
                podcastSuggestions: [
                    {
                        name: 'The Joe Rogan Experience',
                        author: 'Joe Rogan',
                        description: 'Conversations with various guests about life, current events, and everything in between.',
                        rss_url: 'https://feeds.megaphone.fm/GLT9026740164'
                    },
                    {
                        name: 'This American Life',
                        author: 'Ira Glass',
                        description: 'Each week we choose a theme and put together different kinds of stories on that theme.',
                        rss_url: 'https://feeds.thisamericanlife.org/talpodcast'
                    },
                    {
                        name: 'Serial',
                        author: 'Sarah Koenig',
                        description: 'Serial tells one story - a true story - over the course of a whole season.',
                        rss_url: 'https://feeds.serialpodcast.com/serial'
                    },
                    {
                        name: 'Freakonomics Radio',
                        author: 'Stephen J. Dubner',
                        description: 'Discover the hidden side of everything with host Stephen J. Dubner.',
                        rss_url: 'https://feeds.simplecast.com/Y8lFbOT4'
                    },
                    {
                        name: 'The Daily',
                        author: 'The New York Times',
                        description: 'The biggest stories of our time, told by the best journalists in the world.',
                        rss_url: 'https://feeds.simplecast.com/54nAGcIl'
                    },
                    {
                        name: 'Radiolab',
                        author: 'WNYC Studios',
                        description: 'Radiolab is on a curiosity bender. We ask deep questions and use investigative journalism.',
                        rss_url: 'https://feeds.wnyc.org/radiolab'
                    }
                ],
                
                // Notification
                notification: {
                    show: false,
                    message: '',
                    type: 'success'
                },

                async init() {
                    // Check authentication
                    this.token = localStorage.getItem('auth_token');
                    this.userEmail = localStorage.getItem('user_email');
                    
                    if (!this.token) {
                        window.location.href = '/login';
                        return;
                    }

                    // Load data and settings
                    this.loadEmailSettings();
                    await this.loadAllData();
                },

                async apiRequest(url, options = {}) {
                    const defaultOptions = {
                        headers: {
                            'Authorization': `Bearer ${this.token}`,
                            'Content-Type': 'application/json',
                            ...options.headers
                        }
                    };

                    const response = await fetch(url, { ...options, ...defaultOptions });
                    
                    if (response.status === 401 || response.status === 403) {
                        // Token expired, redirect to login
                        localStorage.removeItem('auth_token');
                        localStorage.removeItem('user_email');
                        window.location.href = '/login';
                        return null;
                    }

                    return response.json();
                },

                async loadAllData() {
                    this.loading = true;
                    try {
                        // Load all data concurrently
                        const [statsData, analysesData, knowledgeData, podcastsData] = await Promise.all([
                            this.apiRequest('/api/user/stats'),
                            this.apiRequest('/api/recent-analyses'),
                            this.apiRequest('/api/knowledge-base'),
                            this.apiRequest('/api/podcasts')
                        ]);

                        if (statsData) this.stats = statsData;
                        if (analysesData) this.recentAnalyses = analysesData.analyses || [];
                        if (knowledgeData) this.knowledgeEntries = knowledgeData.entries || [];
                        if (podcastsData) this.podcasts = podcastsData.podcasts || [];

                    } catch (error) {
                        this.showNotification('Error loading data', 'error');
                    } finally {
                        this.loading = false;
                    }
                },

                async sendTestEmail() {
                    this.loading = true;
                    try {
                        const response = await this.apiRequest('/email/test', { method: 'POST' });
                        if (response) {
                            this.showNotification('Test email sent successfully!', 'success');
                        }
                    } catch (error) {
                        this.showNotification('Failed to send test email', 'error');
                    } finally {
                        this.loading = false;
                    }
                },

                async sendWeeklyDigest() {
                    this.loading = true;
                    try {
                        const response = await this.apiRequest('/email/weekly-digest', { method: 'POST' });
                        if (response) {
                            this.showNotification('Weekly digest sent successfully!', 'success');
                        }
                    } catch (error) {
                        this.showNotification('Failed to send weekly digest', 'error');
                    } finally {
                        this.loading = false;
                    }
                },

                logout() {
                    localStorage.removeItem('auth_token');
                    localStorage.removeItem('user_email');
                    window.location.href = '/login';
                },

                showNotification(message, type = 'success') {
                    this.notification = {
                        show: true,
                        message: message,
                        type: type
                    };

                    setTimeout(() => {
                        this.notification.show = false;
                    }, 3000);
                },

                // Knowledge Base Functions
                async viewFullAnalysis(entryId) {
                    // Try to find the analysis report ID from the knowledge entry
                    const entry = this.knowledgeEntries.find(e => e.id === entryId);
                    if (entry && entry.analysis_report_id) {
                        try {
                            const analysis = await this.apiRequest(`/api/analysis/${entry.analysis_report_id}`);
                            if (analysis) {
                                // Create a modal dialog to show the full analysis
                                const modal = document.createElement('div');
                                modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4';
                                modal.innerHTML = `
                                    <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                                        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                                            <h3 class="text-lg font-medium text-gray-900">Full Analysis</h3>
                                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                        <div class="px-6 py-4">
                                            <h4 class="font-semibold text-gray-900 mb-2">${analysis.episode_title}</h4>
                                            <p class="text-sm text-gray-500 mb-4">${analysis.podcast_name} • ${analysis.reading_time_minutes} min read</p>
                                            ${analysis.key_quote ? `<div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 mb-4">
                                                <p class="text-sm text-yellow-700 italic">"${analysis.key_quote}"</p>
                                            </div>` : ''}
                                            <div class="prose max-w-none">
                                                <p class="whitespace-pre-wrap">${analysis.analysis_result}</p>
                                            </div>
                                        </div>
                                    </div>
                                `;
                                document.body.appendChild(modal);
                            }
                        } catch (error) {
                            this.showNotification('Could not load full analysis', 'error');
                        }
                    }
                },

                async viewTranscript(episodeId) {
                    if (episodeId) {
                        try {
                            const transcript = await this.apiRequest(`/api/episodes/${episodeId}/transcript`);
                            if (transcript) {
                                // Create a modal dialog to show the transcript
                                const modal = document.createElement('div');
                                modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4';
                                modal.innerHTML = `
                                    <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                                        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                                            <h3 class="text-lg font-medium text-gray-900">Episode Transcript</h3>
                                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                        <div class="px-6 py-4">
                                            <h4 class="font-semibold text-gray-900 mb-2">${transcript.episode_title}</h4>
                                            <div class="prose max-w-none">
                                                <p class="whitespace-pre-wrap">${transcript.transcript}</p>
                                            </div>
                                        </div>
                                    </div>
                                `;
                                document.body.appendChild(modal);
                            }
                        } catch (error) {
                            this.showNotification('Could not load transcript', 'error');
                        }
                    }
                },

                async toggleFavorite(entryId) {
                    // This would need an API endpoint to toggle favorites
                    this.showNotification('Favorite toggling not yet implemented', 'error');
                },

                // Podcast Management Functions
                async addNewPodcast() {
                    this.loading = true;
                    try {
                        const response = await this.apiRequest('/api/podcasts', {
                            method: 'POST',
                            body: JSON.stringify(this.newPodcast)
                        });
                        
                        if (response) {
                            this.showNotification('Podcast added successfully!', 'success');
                            this.showAddPodcast = false;
                            this.newPodcast = { name: '', rss_url: '', author: '', description: '' };
                            await this.loadAllData(); // Refresh data
                            return true;
                        }
                        return false;
                    } catch (error) {
                        this.showNotification('Failed to add podcast', 'error');
                        return false;
                    } finally {
                        this.loading = false;
                    }
                },

                async quickAddPodcast(suggestion) {
                    this.newPodcast = {
                        name: suggestion.name,
                        rss_url: suggestion.rss_url,
                        author: suggestion.author,
                        description: suggestion.description
                    };
                    const success = await this.addNewPodcast();
                    if (success) {
                        // Remove the suggestion from the list after successful addition
                        const index = this.podcastSuggestions.findIndex(s => s.rss_url === suggestion.rss_url);
                        if (index > -1) {
                            this.podcastSuggestions.splice(index, 1);
                        }
                    }
                },

                async editPrompt(podcastId) {
                    try {
                        // Get current prompt
                        const promptData = await this.apiRequest(`/api/podcasts/${podcastId}/prompt`);
                        
                        // Create modal for editing prompt
                        const modal = document.createElement('div');
                        modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4';
                        modal.innerHTML = `
                            <div class="bg-white rounded-lg max-w-2xl w-full">
                                <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                                    <h3 class="text-lg font-medium text-gray-900">Edit Analysis Prompt</h3>
                                    <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div class="px-6 py-4">
                                    <p class="text-sm text-gray-600 mb-4">Podcast: <strong>${promptData.podcast_name}</strong></p>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Custom Analysis Prompt</label>
                                    <textarea id="promptTextarea" rows="6" class="w-full border border-gray-300 rounded-md px-3 py-2">${promptData.custom_prompt}</textarea>
                                    <div class="mt-4 flex justify-end space-x-3">
                                        <button onclick="this.closest('.fixed').remove()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400">
                                            Cancel
                                        </button>
                                        <button onclick="savePrompt(${podcastId})" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">
                                            Save Prompt
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        document.body.appendChild(modal);
                        
                        // Add global save function
                        window.savePrompt = async (podcastId) => {
                            const textarea = document.getElementById('promptTextarea');
                            const newPrompt = textarea.value.trim();
                            
                            if (!newPrompt) {
                                alert('Prompt cannot be empty');
                                return;
                            }
                            
                            try {
                                await this.apiRequest(`/api/podcasts/${podcastId}/prompt`, {
                                    method: 'PUT',
                                    body: JSON.stringify({ custom_prompt: newPrompt })
                                });
                                
                                this.showNotification('Prompt updated successfully!', 'success');
                                modal.remove();
                            } catch (error) {
                                this.showNotification('Failed to update prompt', 'error');
                            }
                        };
                        
                    } catch (error) {
                        this.showNotification('Could not load prompt', 'error');
                    }
                },

                async processRSS(podcastId) {
                    this.loading = true;
                    try {
                        const response = await this.apiRequest(`/tasks/process-rss/${podcastId}`, {
                            method: 'POST'
                        });
                        
                        if (response) {
                            this.showNotification('RSS processing started! Check back later for new episodes.', 'success');
                        }
                    } catch (error) {
                        this.showNotification('Failed to process RSS feed', 'error');
                    } finally {
                        this.loading = false;
                    }
                },

                async deletePodcast(podcastId, podcastName) {
                    if (!confirm(`Are you sure you want to delete "${podcastName}"? This will delete all episodes, analyses, and knowledge base entries for this podcast. This action cannot be undone.`)) {
                        return;
                    }
                    
                    this.loading = true;
                    try {
                        const response = await this.apiRequest(`/api/podcasts/${podcastId}`, {
                            method: 'DELETE'
                        });
                        
                        if (response) {
                            this.showNotification(`Podcast "${podcastName}" deleted successfully!`, 'success');
                            await this.loadAllData(); // Refresh data
                        }
                    } catch (error) {
                        this.showNotification('Failed to delete podcast', 'error');
                    } finally {
                        this.loading = false;
                    }
                },

                // Email Settings Functions
                async updateEmailSettings() {
                    this.loading = true;
                    try {
                        // For now, just save locally (would need API endpoint in real app)
                        localStorage.setItem('email_settings', JSON.stringify(this.emailSettings));
                        
                        this.showNotification('Email settings updated successfully!', 'success');
                        this.showEmailSettings = false;
                    } catch (error) {
                        this.showNotification('Failed to update email settings', 'error');
                    } finally {
                        this.loading = false;
                    }
                },

                loadEmailSettings() {
                    const saved = localStorage.getItem('email_settings');
                    if (saved) {
                        this.emailSettings = { ...this.emailSettings, ...JSON.parse(saved) };
                    }
                }
            }
        }
    </script>
</body>
</html>