{% extends "base.html" %}

{% block title %}Knowledge Base - Podcast Analysis v2{% endblock %}

{% block content %}
<div x-data="knowledgeBase()" x-init="loadKnowledgeBase()">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">
                    <i class="fas fa-brain mr-3 text-purple-600"></i>
                    Your Knowledge Base
                </h1>
                <p class="mt-2 text-gray-600">Organize, search, and explore your podcast learning insights.</p>
            </div>
            
            <div class="flex items-center space-x-4">
                <!-- View Toggle -->
                <div class="flex bg-gray-200 rounded-lg p-1">
                    <button @click="currentView = 'categories'" 
                            :class="currentView === 'categories' ? 'bg-white shadow' : ''"
                            class="px-3 py-1 rounded-md text-sm font-medium">
                        <i class="fas fa-th-large mr-1"></i>
                        Categories
                    </button>
                    <button @click="currentView = 'timeline'" 
                            :class="currentView === 'timeline' ? 'bg-white shadow' : ''"
                            class="px-3 py-1 rounded-md text-sm font-medium">
                        <i class="fas fa-clock mr-1"></i>
                        Timeline
                    </button>
                    <button @click="currentView = 'favorites'" 
                            :class="currentView === 'favorites' ? 'bg-white shadow' : ''"
                            class="px-3 py-1 rounded-md text-sm font-medium">
                        <i class="fas fa-star mr-1"></i>
                        Favorites
                    </button>
                </div>
                
                <!-- Email Settings -->
                <div class="flex items-center space-x-2">
                    <button @click="sendTestEmail()" class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        <i class="fas fa-envelope-open mr-2 text-blue-600"></i>
                        Test Email
                    </button>
                    
                    <button @click="sendWeeklyDigest()" class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        <i class="fas fa-paper-plane mr-2 text-green-600"></i>
                        Send Digest
                    </button>
                    
                    <button @click="showEmailSettings()" class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        <i class="fas fa-cog mr-2 text-gray-600"></i>
                        Email Settings
                    </button>
                </div>
                
                <!-- Category Management -->
                <button @click="showCategoryModal = true" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-purple-600 hover:bg-purple-700">
                    <i class="fas fa-plus mr-2"></i>
                    New Category
                </button>
            </div>
        </div>
    </div>

    <!-- Search Bar -->
    <div class="mb-6">
        <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fas fa-search text-gray-400"></i>
            </div>
            <input x-model="searchQuery" @input="searchEntries()" type="text" 
                   class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-purple-500 focus:border-purple-500 sm:text-sm" 
                   placeholder="Search your knowledge base...">
        </div>
    </div>

    <!-- Stats Bar -->
    <div class="mb-8 grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="bg-white p-4 rounded-lg shadow">
            <div class="flex items-center">
                <i class="fas fa-database text-purple-600 text-xl mr-3"></i>
                <div>
                    <p class="text-sm text-gray-600">Total Entries</p>
                    <p class="text-2xl font-bold text-gray-900" x-text="stats.totalEntries || '0'">0</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white p-4 rounded-lg shadow">
            <div class="flex items-center">
                <i class="fas fa-tags text-blue-600 text-xl mr-3"></i>
                <div>
                    <p class="text-sm text-gray-600">Categories</p>
                    <p class="text-2xl font-bold text-gray-900" x-text="categories.length || '0'">0</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white p-4 rounded-lg shadow">
            <div class="flex items-center">
                <i class="fas fa-star text-yellow-600 text-xl mr-3"></i>
                <div>
                    <p class="text-sm text-gray-600">Favorites</p>
                    <p class="text-2xl font-bold text-gray-900" x-text="stats.favoriteEntries || '0'">0</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white p-4 rounded-lg shadow">
            <div class="flex items-center">
                <i class="fas fa-clock text-green-600 text-xl mr-3"></i>
                <div>
                    <p class="text-sm text-gray-600">This Week</p>
                    <p class="text-2xl font-bold text-gray-900" x-text="stats.thisWeekEntries || '0'">0</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Category View -->
    <div x-show="currentView === 'categories'" class="space-y-8">
        <template x-for="category in categories" :key="category.id || 'uncategorized'">
            <div class="bg-white shadow rounded-lg overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div :style="`background-color: ${category.color_code || '#6B7280'}`" 
                                 class="w-4 h-4 rounded-full mr-3"></div>
                            <h3 class="text-lg font-medium text-gray-900" x-text="category.category_name || 'Uncategorized'">
                            </h3>
                            <span class="ml-2 bg-gray-100 text-gray-600 px-2 py-1 rounded-full text-sm" 
                                  x-text="`${category.entries?.length || 0} entries`">
                            </span>
                        </div>
                        
                        <div class="flex items-center space-x-2">
                            <button @click="editCategory(category)" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button @click="exportCategory(category)" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </div>
                    
                    <p x-show="category.description" class="mt-2 text-sm text-gray-600" x-text="category.description">
                    </p>
                </div>
                
                <div class="px-6 py-4">
                    <div x-show="!category.entries || category.entries.length === 0" class="text-center py-8">
                        <i class="fas fa-folder-open text-3xl text-gray-300 mb-2"></i>
                        <p class="text-gray-500">No entries in this category yet</p>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <template x-for="entry in category.entries" :key="entry.id">
                            <div class="knowledge-card border border-gray-200 rounded-lg p-4 cursor-pointer" 
                                 @click="openEntry(entry)">
                                <div class="flex items-start justify-between mb-3">
                                    <h4 class="font-medium text-gray-900 flex-1" x-text="entry.entry_title">
                                    </h4>
                                    <div class="flex items-center space-x-2 ml-4">
                                        <span x-show="entry.is_favorited" class="text-yellow-400">
                                            <i class="fas fa-star"></i>
                                        </span>
                                        <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-medium">
                                            <i class="fas fa-clock mr-1"></i>
                                            <span x-text="PodcastApp.formatReadingTime(entry.reading_time_minutes)"></span>
                                        </span>
                                    </div>
                                </div>
                                
                                <p class="text-sm text-gray-600 mb-2" x-text="entry.podcast_name">
                                </p>
                                
                                <p class="text-sm text-gray-700 line-clamp-3" 
                                   x-text="entry.key_insights?.substring(0, 150) + (entry.key_insights?.length > 150 ? '...' : '')">
                                </p>
                                
                                <div x-show="entry.tags" class="mt-3 flex flex-wrap gap-1">
                                    <template x-for="tag in (entry.tags || '').split(',').filter(t => t.trim())" :key="tag">
                                        <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded-full text-xs" x-text="tag.trim()">
                                        </span>
                                    </template>
                                </div>
                                
                                <div class="mt-3 text-xs text-gray-500">
                                    <span x-text="PodcastApp.formatDate(entry.created_at)"></span>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- Timeline View -->
    <div x-show="currentView === 'timeline'" class="space-y-6">
        <template x-for="timelineGroup in timelineData" :key="timelineGroup.date">
            <div class="bg-white shadow rounded-lg overflow-hidden">
                <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900" x-text="timelineGroup.date">
                    </h3>
                    <p class="text-sm text-gray-600" x-text="`${timelineGroup.entries.length} entries`">
                    </p>
                </div>
                
                <div class="px-6 py-4">
                    <div class="space-y-4">
                        <template x-for="entry in timelineGroup.entries" :key="entry.id">
                            <div class="flex items-start space-x-4 p-4 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer"
                                 @click="openEntry(entry)">
                                <div :style="`background-color: ${getCategoryColor(entry.podcast_category)}`" 
                                     class="w-3 h-3 rounded-full mt-2 flex-shrink-0"></div>
                                
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <h4 class="font-medium text-gray-900" x-text="entry.entry_title">
                                            </h4>
                                            <p class="text-sm text-gray-600 mt-1">
                                                <span x-text="entry.podcast_name"></span> • 
                                                <span x-text="entry.podcast_category || 'Uncategorized'"></span>
                                            </p>
                                        </div>
                                        
                                        <div class="flex items-center space-x-2 ml-4">
                                            <span x-show="entry.is_favorited" class="text-yellow-400">
                                                <i class="fas fa-star"></i>
                                            </span>
                                            <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-medium">
                                                <span x-text="PodcastApp.formatReadingTime(entry.reading_time_minutes)"></span>
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <p class="text-sm text-gray-700 mt-2 line-clamp-2" 
                                       x-text="entry.key_insights?.substring(0, 120) + (entry.key_insights?.length > 120 ? '...' : '')">
                                    </p>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- Favorites View -->
    <div x-show="currentView === 'favorites'" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div x-show="favoriteEntries.length === 0" class="col-span-2 text-center py-12">
            <i class="fas fa-star text-4xl text-gray-300 mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No favorites yet</h3>
            <p class="text-gray-600">Mark insights as favorites to see them here</p>
        </div>
        
        <template x-for="entry in favoriteEntries" :key="entry.id">
            <div class="knowledge-card bg-white shadow rounded-lg p-6 cursor-pointer" @click="openEntry(entry)">
                <div class="flex items-start justify-between mb-4">
                    <div class="flex-1">
                        <h4 class="font-medium text-gray-900 mb-2" x-text="entry.entry_title">
                        </h4>
                        <p class="text-sm text-gray-600">
                            <span x-text="entry.podcast_name"></span> • 
                            <span x-text="entry.podcast_category || 'Uncategorized'"></span> • 
                            <span x-text="PodcastApp.formatDate(entry.created_at)"></span>
                        </p>
                    </div>
                    
                    <i class="fas fa-star text-yellow-400 text-lg"></i>
                </div>
                
                <p class="text-sm text-gray-700 mb-4 line-clamp-3" 
                   x-text="entry.key_insights?.substring(0, 200) + (entry.key_insights?.length > 200 ? '...' : '')">
                </p>
                
                <div x-show="entry.personal_notes" class="bg-blue-50 rounded-md p-3 mb-4">
                    <p class="text-sm text-blue-700">
                        <i class="fas fa-sticky-note mr-1"></i>
                        <strong>Your Notes:</strong> 
                        <span x-text="entry.personal_notes.substring(0, 100) + (entry.personal_notes.length > 100 ? '...' : '')"></span>
                    </p>
                </div>
                
                <div class="flex items-center justify-between">
                    <div x-show="entry.tags" class="flex flex-wrap gap-1">
                        <template x-for="tag in (entry.tags || '').split(',').filter(t => t.trim()).slice(0, 3)" :key="tag">
                            <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded-full text-xs" x-text="tag.trim()">
                            </span>
                        </template>
                    </div>
                    
                    <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-medium">
                        <i class="fas fa-clock mr-1"></i>
                        <span x-text="PodcastApp.formatReadingTime(entry.reading_time_minutes)"></span>
                    </span>
                </div>
            </div>
        </template>
    </div>

    <!-- Category Management Modal -->
    <div x-show="showCategoryModal" x-cloak class="fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div x-show="showCategoryModal" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>

            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

            <div x-show="showCategoryModal" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100" x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <form @submit.prevent="saveCategory()">
                    <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                        <div class="sm:flex sm:items-start">
                            <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                                <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                                    <span x-text="editingCategory ? 'Edit Category' : 'Create New Category'"></span>
                                </h3>
                                <div class="mt-4 space-y-4">
                                    <div>
                                        <label for="category-name" class="block text-sm font-medium text-gray-700">Category Name</label>
                                        <input x-model="categoryForm.category_name" type="text" id="category-name" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 sm:text-sm" placeholder="e.g., Business, Technology, Health">
                                    </div>
                                    
                                    <div>
                                        <label for="category-color" class="block text-sm font-medium text-gray-700">Color</label>
                                        <div class="mt-1 flex items-center space-x-2">
                                            <input x-model="categoryForm.color_code" type="color" id="category-color" class="h-10 w-16 border border-gray-300 rounded-md">
                                            <input x-model="categoryForm.color_code" type="text" class="flex-1 border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 sm:text-sm" placeholder="#6B7280">
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label for="category-description" class="block text-sm font-medium text-gray-700">Description (Optional)</label>
                                        <textarea x-model="categoryForm.description" id="category-description" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 sm:text-sm" placeholder="Brief description of this category..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                        <button type="submit" :disabled="loading" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-purple-600 text-base font-medium text-white hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 sm:ml-3 sm:w-auto sm:text-sm disabled:opacity-50">
                            <span x-show="!loading" x-text="editingCategory ? 'Update' : 'Create'"></span>
                            <span x-show="loading" class="flex items-center">
                                <i class="fas fa-spinner fa-spin mr-2"></i>
                                Saving...
                            </span>
                        </button>
                        <button @click="cancelCategoryEdit()" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function knowledgeBase() {
    return {
        currentView: 'categories',
        searchQuery: '',
        loading: false,
        showCategoryModal: false,
        editingCategory: null,
        
        // Data
        categories: [],
        entries: [],
        favoriteEntries: [],
        timelineData: [],
        stats: {},
        
        // Forms
        categoryForm: {
            category_name: '',
            color_code: '#6B7280',
            description: ''
        },
        
        async loadKnowledgeBase() {
            this.loading = true;
            
            try {
                await this.loadCategories();
                await this.loadEntries();
                await this.loadStats();
                this.organizeData();
                
            } catch (error) {
                PodcastApp.showNotification('Failed to load knowledge base', 'error');
            } finally {
                this.loading = false;
            }
        },
        
        async loadCategories() {
            try {
                const response = await fetch('/api/knowledge-base', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    this.categories = data.categories || [];
                    
                    // Add default uncategorized category if no categories exist
                    if (this.categories.length === 0) {
                        this.categories.push({
                            category_name: 'Uncategorized',
                            color_code: '#6B7280',
                            description: 'Entries not yet categorized',
                            entries: []
                        });
                    }
                } else {
                    // Fallback categories for new users
                    this.categories = [{
                        category_name: 'Uncategorized',
                        color_code: '#6B7280',
                        description: 'Entries not yet categorized',
                        entries: []
                    }];
                }
            } catch (error) {
                console.error('Failed to load categories:', error);
                this.categories = [{
                    category_name: 'Uncategorized',
                    color_code: '#6B7280',
                    description: 'Entries not yet categorized',
                    entries: []
                }];
            }
        },
        
        async loadEntries() {
            try {
                const response = await fetch('/api/knowledge-base', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    this.entries = data.entries || [];
                } else {
                    this.entries = [];
                }
            } catch (error) {
                console.error('Failed to load entries:', error);
                this.entries = [];
            }
        },
        
        async loadStats() {
            this.stats = {
                totalEntries: this.entries.length,
                favoriteEntries: this.entries.filter(e => e.is_favorited).length,
                thisWeekEntries: this.entries.filter(e => {
                    const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                    return new Date(e.created_at) > weekAgo;
                }).length
            };
        },
        
        organizeData() {
            // Organize entries by category
            this.categories.forEach(category => {
                category.entries = this.entries.filter(entry => 
                    entry.podcast_category === category.category_name || 
                    (!entry.podcast_category && category.category_name === 'Uncategorized')
                );
            });
            
            // Create timeline data
            this.createTimelineData();
            
            // Set favorite entries
            this.favoriteEntries = this.entries.filter(entry => entry.is_favorited);
        },
        
        createTimelineData() {
            const grouped = {};
            
            this.entries.forEach(entry => {
                const date = new Date(entry.created_at).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                if (!grouped[date]) {
                    grouped[date] = [];
                }
                grouped[date].push(entry);
            });
            
            this.timelineData = Object.entries(grouped).map(([date, entries]) => ({
                date,
                entries: entries.sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
            })).sort((a, b) => new Date(b.entries[0].created_at) - new Date(a.entries[0].created_at));
        },
        
        searchEntries() {
            if (!this.searchQuery.trim()) {
                this.organizeData();
                return;
            }
            
            const query = this.searchQuery.toLowerCase();
            const filtered = this.entries.filter(entry => 
                entry.entry_title.toLowerCase().includes(query) ||
                entry.key_insights.toLowerCase().includes(query) ||
                (entry.personal_notes && entry.personal_notes.toLowerCase().includes(query)) ||
                (entry.tags && entry.tags.toLowerCase().includes(query))
            );
            
            // Update categories with filtered entries
            this.categories.forEach(category => {
                category.entries = filtered.filter(entry => 
                    entry.podcast_category === category.category_name || 
                    (!entry.podcast_category && category.category_name === 'Uncategorized')
                );
            });
            
            // Update other views
            this.favoriteEntries = filtered.filter(entry => entry.is_favorited);
            this.createTimelineDataFromEntries(filtered);
        },
        
        createTimelineDataFromEntries(entries) {
            const grouped = {};
            
            entries.forEach(entry => {
                const date = new Date(entry.created_at).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                if (!grouped[date]) {
                    grouped[date] = [];
                }
                grouped[date].push(entry);
            });
            
            this.timelineData = Object.entries(grouped).map(([date, entries]) => ({
                date,
                entries: entries.sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
            })).sort((a, b) => new Date(b.entries[0].created_at) - new Date(a.entries[0].created_at));
        },
        
        getCategoryColor(categoryName) {
            const category = this.categories.find(c => c.category_name === categoryName);
            return category ? category.color_code : '#6B7280';
        },
        
        openEntry(entry) {
            // In a real app, would navigate to detailed entry view
            PodcastApp.showNotification(`Opening: ${entry.entry_title}`, 'info');
        },
        
        editCategory(category) {
            this.editingCategory = category;
            this.categoryForm = {
                category_name: category.category_name,
                color_code: category.color_code,
                description: category.description || ''
            };
            this.showCategoryModal = true;
        },
        
        async saveCategory() {
            this.loading = true;
            
            try {
                if (this.editingCategory) {
                    // Update existing category
                    Object.assign(this.editingCategory, this.categoryForm);
                    PodcastApp.showNotification('Category updated successfully', 'success');
                } else {
                    // Create new category
                    const newCategory = {
                        id: Date.now(),
                        ...this.categoryForm,
                        entries: []
                    };
                    this.categories.push(newCategory);
                    PodcastApp.showNotification('Category created successfully', 'success');
                }
                
                this.cancelCategoryEdit();
                
            } catch (error) {
                PodcastApp.showNotification('Failed to save category', 'error');
            } finally {
                this.loading = false;
            }
        },
        
        cancelCategoryEdit() {
            this.showCategoryModal = false;
            this.editingCategory = null;
            this.categoryForm = {
                category_name: '',
                color_code: '#6B7280',
                description: ''
            };
        },
        
        exportCategory(category) {
            // Simple CSV export simulation
            const csvContent = category.entries.map(entry => 
                `"${entry.entry_title}","${entry.podcast_name}","${entry.key_insights}","${entry.personal_notes || ''}","${entry.tags || ''}"`
            ).join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `${category.category_name.replace(/\s+/g, '_')}_knowledge_base.csv`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            PodcastApp.showNotification(`Exported ${category.category_name} category`, 'success');
        },
        
        async sendTestEmail() {
            try {
                const response = await fetch('/email/test', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    PodcastApp.showNotification('Test email sent successfully!', 'success');
                } else {
                    PodcastApp.showNotification(result.detail || 'Failed to send test email', 'error');
                }
            } catch (error) {
                PodcastApp.showNotification('Failed to send test email', 'error');
            }
        },
        
        async sendWeeklyDigest() {
            try {
                const response = await fetch('/email/digest', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    PodcastApp.showNotification('Weekly digest sent successfully!', 'success');
                } else {
                    PodcastApp.showNotification(result.detail || 'Failed to send weekly digest', 'error');
                }
            } catch (error) {
                PodcastApp.showNotification('Failed to send weekly digest', 'error');
            }
        },
        
        showEmailSettings() {
            // Navigate to email settings - in a real app would open modal or navigate
            PodcastApp.showNotification('Email settings would open here', 'info');
        }
    }
}
</script>
{% endblock %}